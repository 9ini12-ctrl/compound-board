<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª</title>

  <!-- PWA / iOS Add to Home Screen -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0b1220">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <link rel="icon" href="icons/icon-192.png">

  <style id="appCSS">
    :root{
      --bg: #f6f8fb;
      --ink: rgba(11,18,32,.92);
      --muted: rgba(11,18,32,.62);
      --line: rgba(11,18,32,.10);
      --card: rgba(255,255,255,.86);
      --glass: rgba(255,255,255,.72);
      --shadow: 0 18px 54px rgba(16,24,40,.10);
      --shadow2: 0 26px 80px rgba(16,24,40,.18);
      --r: 22px;
      --r2: 18px;
      --safeTop: env(safe-area-inset-top);
      --safeBot: env(safe-area-inset-bottom);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Arial;
      background: radial-gradient(1200px 800px at 80% -10%, rgba(59,130,246,.12), transparent 60%),
                  radial-gradient(900px 600px at 10% 0%, rgba(16,185,129,.10), transparent 55%),
                  var(--bg);
      color: var(--ink);
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
    }

    .shell{max-width: 1180px; margin: 0 auto; padding: 14px 14px calc(86px + var(--safeBot));}

    header{
      position: sticky; top: 0; z-index: 30;
      padding-top: max(10px, var(--safeTop));
      background: linear-gradient(to bottom, rgba(246,248,251,.92), rgba(246,248,251,.78));
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border-bottom: 1px solid rgba(11,18,32,.06);
    }
    .topBar{
      display:flex; align-items:center; justify-content:space-between; gap: 12px;
      padding: 10px 14px 12px;
      max-width: 1180px; margin:0 auto;
    }
    .brand{
      display:flex; align-items:center; gap: 10px;
      font-weight: 1100;
      letter-spacing: -0.02em;
      cursor: pointer;
      user-select:none;
    }
    .mark{
      width: 34px; height: 34px; border-radius: 12px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.95), rgba(255,255,255,.32)),
                  linear-gradient(135deg, rgba(59,130,246,.68), rgba(16,185,129,.48));
      box-shadow: 0 16px 36px rgba(16,24,40,.14);
      border: 1px solid rgba(255,255,255,.55);
    }
    .brand .t{display:flex; flex-direction:column; line-height:1.05}
    .brand .t b{font-size: 14px}
    .brand .t span{font-size: 11px; color: var(--muted); font-weight: 900}

    .right{
      display:flex; align-items:center; gap: 10px;
      flex-wrap: wrap;
      justify-content:flex-end;
    }

    .onlineBadge{
      display:flex; align-items:center; gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      background: var(--glass);
      border: 1px solid var(--line);
      box-shadow: 0 12px 30px rgba(16,24,40,.08);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      color: rgba(11,18,32,.78);
      font-weight: 1000;
      white-space:nowrap;
    }
    .onlineBadge .dot{width:8px; height:8px; border-radius:99px; background: rgba(34,197,94,.85);}
    .onlineBadge .lbl{font-size: 12px}
    .onlineBadge .num{font-size: 13px; padding: 2px 8px; border-radius: 999px; background: rgba(11,18,32,.06); color: rgba(11,18,32,.88);}

    .chip{
      display:inline-flex; align-items:center; gap: 8px;
      padding: 8px 10px;
      border-radius: 999px;
      background: var(--glass);
      border: 1px solid var(--line);
      color: rgba(11,18,32,.78);
      font-weight: 1000;
      white-space:nowrap;
    }
    .chip .k{font-size: 11px; color: var(--muted); font-weight: 900}
    .chip .v{font-size: 12px}

    .btn{
      appearance:none;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.84);
      color: rgba(11,18,32,.84);
      font-weight: 1100;
      border-radius: 999px;
      padding: 10px 12px;
      cursor:pointer;
      box-shadow: 0 10px 26px rgba(16,24,40,.06);
      transition: transform .12s ease, box-shadow .14s ease, background .14s ease;
      user-select:none;
    }
    .btn:active{transform: scale(.98)}
    .btn.primary{
      border-color: rgba(11,18,32,.12);
      background: rgba(11,18,32,.92);
      color: rgba(255,255,255,.96);
      box-shadow: 0 16px 38px rgba(16,24,40,.16);
    }
    .btn.ghost{
      background: transparent;
      box-shadow:none;
    }
    .btn.small{padding: 8px 10px; font-size: 12px; border-radius: 14px}
    .btn:disabled{opacity:.55; cursor:not-allowed}

    /* Segmented control */
    .seg{
      display:flex; gap: 8px;
      padding: 6px;
      border-radius: 999px;
      background: rgba(255,255,255,.65);
      border: 1px solid rgba(11,18,32,.08);
      box-shadow: 0 16px 40px rgba(16,24,40,.06);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
    }
    .seg button{
      border: 0; background: transparent;
      border-radius: 999px;
      padding: 10px 12px;
      cursor:pointer;
      font-weight: 1100;
      color: rgba(11,18,32,.68);
      transition: .14s ease;
    }
    .seg button.active{
      background: rgba(11,18,32,.92);
      color: rgba(255,255,255,.96);
      box-shadow: 0 14px 34px rgba(16,24,40,.14);
    }

    /* Toolbar */
    .toolbar{
      margin-top: 12px;
      display:flex; align-items:center; justify-content:space-between; gap: 12px;
      flex-wrap: wrap;
    }
    .search{
      flex: 1;
      min-width: 220px;
      display:flex;
      gap: 8px;
      align-items:center;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.82);
      border: 1px solid var(--line);
      box-shadow: 0 14px 38px rgba(16,24,40,.06);
    }
    .search input{
      border:0; outline:0; background:transparent;
      width:100%;
      font-weight: 900;
      color: rgba(11,18,32,.82);
      font-size: 14px;
    }
    select, input, textarea{font-family: inherit}
    .filters{
      display:flex; gap: 10px; flex-wrap: wrap;
    }
    .select{
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.82);
      padding: 10px 12px;
      font-weight: 1000;
      color: rgba(11,18,32,.78);
      box-shadow: 0 14px 38px rgba(16,24,40,.06);
    }

    /* Views */
    .view{display:none}
    .view.active{display:block}

    /* Board */
    .grid{
      margin-top: 14px;
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }
    @media (max-width: 980px){ .grid{grid-template-columns: repeat(2, 1fr);} }
    @media (max-width: 640px){ .grid{grid-template-columns: 1fr;} }

    .card{
      border-radius: var(--r);
      background: var(--card);
      border: 1px solid var(--line);
      box-shadow: var(--shadow);
      overflow:hidden;
      cursor:pointer;
      transform: translateZ(0);
      transition: transform .14s ease, box-shadow .18s ease, border-color .18s ease;
    }
    .card:active{transform: scale(.99)}
    .card:hover{box-shadow: var(--shadow2); border-color: rgba(11,18,32,.14)}
    .cardIn{
      padding: 12px 12px 12px;
    }
    .row{display:flex; align-items:center; justify-content:space-between; gap: 10px;}
    .name{
      font-weight: 1200;
      font-size: 16px;
      letter-spacing: -0.02em;
      color: rgba(11,18,32,.92);
      line-height: 1.15;
    }
    .meta{
      font-size: 12px;
      color: var(--muted);
      font-weight: 900;
      margin-top: 6px;
      display:flex; gap: 8px; flex-wrap: wrap;
    }
    .pill{
      display:inline-flex; align-items:center; gap: 6px;
      padding: 7px 10px;
      border-radius: 999px;
      background: rgba(11,18,32,.05);
      color: rgba(11,18,32,.78);
      font-weight: 1000;
      border: 1px solid rgba(11,18,32,.07);
    }
    .pill b{font-weight: 1200}
    .k{font-size: 11px; color: rgba(11,18,32,.55); font-weight: 900}
    .big{
      font-weight: 1300;
      font-size: 22px;
      letter-spacing: -0.03em;
      line-height: 1.1;
      display:flex; align-items:baseline; gap: 6px;
    }
    .sar{font-size: 12px; color: rgba(11,18,32,.55); font-weight: 900}
    .bar{
      margin-top: 10px;
      height: 10px;
      border-radius: 999px;
      background: rgba(11,18,32,.08);
      overflow:hidden;
    }
    .fill{
      height:100%;
      width:0%;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(59,130,246,.92), rgba(16,185,129,.80));
    }
    .smallRow{
      margin-top: 10px;
      display:flex; justify-content:space-between; gap: 10px;
      font-size: 11px;
      font-weight: 900;
      color: rgba(11,18,32,.62);
    }

    /* List (table) */
    .tableWrap{
      margin-top: 14px;
      border-radius: var(--r);
      border: 1px solid var(--line);
      background: rgba(255,255,255,.72);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    table{width:100%; border-collapse: collapse; font-size: 12px;}
    thead th{
      text-align: right;
      padding: 12px 12px;
      color: rgba(11,18,32,.62);
      font-weight: 1000;
      border-bottom: 1px solid rgba(11,18,32,.08);
      background: rgba(255,255,255,.78);
      position: sticky; top: 0; z-index: 1;
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
    }
    tbody td{
      padding: 10px 12px;
      border-bottom: 1px solid rgba(11,18,32,.06);
      color: rgba(11,18,32,.82);
      font-weight: 900;
      vertical-align: top;
    }
    tbody tr:hover td{background: rgba(59,130,246,.04)}
    .edit{
      width: 100%;
      border: 1px solid rgba(11,18,32,.10);
      background: rgba(255,255,255,.78);
      border-radius: 12px;
      padding: 9px 10px;
      font-weight: 900;
      color: rgba(11,18,32,.84);
      outline: none;
    }
    .edit:focus{border-color: rgba(59,130,246,.40); box-shadow: 0 0 0 6px rgba(59,130,246,.10)}
    .rowBtns{display:flex; gap: 8px; flex-wrap: wrap;}

    /* Detail page (iPhone style) */
    .detailPage{display:none; position:fixed; inset:0; z-index: 80; background: rgba(248,250,252,.98);}
    .detailPage.isOpen{display:block}
    .detailTop{
      position: sticky; top:0; z-index: 5;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding: 10px 12px;
      padding-top: max(10px, var(--safeTop));
      background: rgba(255,255,255,.86);
      border-bottom: 1px solid rgba(11,18,32,.10);
      backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
    }
    .detailTitle{font-weight:1200; font-size: 14px; color: rgba(11,18,32,.78); text-align:center; flex:1;}
    .detailTabs{
      position: sticky;
      top: calc(56px + var(--safeTop));
      z-index: 4;
      display:flex; gap:8px;
      padding: 10px 12px;
      background: rgba(248,250,252,.88);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border-bottom: 1px solid rgba(11,18,32,.08);
    }
    .detailTab{
      flex:1;
      border: 1px solid rgba(11,18,32,.10);
      background: rgba(255,255,255,.78);
      color: rgba(11,18,32,.74);
      border-radius: 999px;
      padding: 10px 10px;
      font-weight: 1100;
      font-size: 12px;
      cursor:pointer;
      transition: .14s ease;
    }
    .detailTab.active{
      background: rgba(11,18,32,.92);
      color: rgba(255,255,255,.96);
      box-shadow: 0 10px 26px rgba(16,24,40,.18);
    }
    .detailKPIWrap{
      position: sticky;
      top: calc(56px + 56px + var(--safeTop));
      z-index: 3;
      padding: 12px;
      background: rgba(248,250,252,.88);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border-bottom: 1px solid rgba(11,18,32,.08);
    }
    .detailKPIGrid{display:grid; grid-template-columns: 1fr 1fr; gap: 10px;}
    .detailKPI{
      border-radius: var(--r2);
      background: rgba(255,255,255,.86);
      border: 1px solid rgba(11,18,32,.10);
      box-shadow: 0 12px 34px rgba(16,24,40,.10);
      padding: 10px 12px;
    }
    .detailKPI .kk{font-size:11px; color: rgba(11,18,32,.58); font-weight: 900}
    .detailKPI .vv{margin-top: 6px; font-size: 20px; font-weight: 1300; letter-spacing:-0.02em; display:flex; align-items:baseline; justify-content:space-between; gap: 8px;}
    .detailKPI .vv .sar{font-size:12px}
    .detailKPI .sub{margin-top: 6px; font-size: 11px; color: rgba(11,18,32,.58); font-weight: 900; line-height:1.35}

    .detailBody{height: calc(100% - 56px); overflow:auto; -webkit-overflow-scrolling:touch;}
    .detailPanel{display:none; padding: 12px 12px 96px;}
    .detailPanel.active{display:block}

    .stageList{display:flex; flex-direction:column; gap:10px;}
    .stageRow{
      border-radius: var(--r2);
      background: rgba(255,255,255,.86);
      border: 1px solid rgba(11,18,32,.10);
      box-shadow: 0 12px 34px rgba(16,24,40,.10);
      padding: 12px;
    }
    .stageRowTop{display:flex; justify-content:space-between; align-items:center; gap:10px;}
    .stageName{font-weight: 1100; font-size: 13px; color: rgba(11,18,32,.86);}
    .stageTarget{font-weight: 1300; font-size: 18px; color: rgba(11,18,32,.92);}
    .stageTarget .sar{font-size: 12px; color: rgba(11,18,32,.55); font-weight: 900; margin-inline-start: 6px;}
    .stageBar{height: 10px; border-radius: 999px; background: rgba(11,18,32,.08); overflow:hidden; margin-top:10px;}
    .stageFill{height:100%; border-radius:999px; width:0%;}
    .stageMeta{margin-top: 8px; display:flex; justify-content:space-between; font-size: 11px; color: rgba(11,18,32,.60); font-weight: 900;}

    .hint{padding: 10px 12px; font-size: 11px; color: rgba(11,18,32,.55); font-weight: 900; text-align:center;}

    /* Bottom nav (mobile) */
    .mNav{
      position: fixed;
      left: 10px; right: 10px;
      bottom: max(10px, var(--safeBot));
      z-index: 60;
      border-radius: 999px;
      padding: 6px;
      background: rgba(255,255,255,.74);
      border: 1px solid rgba(11,18,32,.10);
      box-shadow: 0 18px 60px rgba(16,24,40,.18);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      display:none;
    }
    .mNav .seg{width:100%; justify-content:space-between}
    @media (max-width: 640px){ .mNav{display:block} }

    /* Modal (Admin unlock + Conflict) */
    .modal{position:fixed; inset:0; display:none; z-index:120;}
    .modal.open{display:block;}
    .backdrop{position:absolute; inset:0; background: rgba(10,14,20,.28); backdrop-filter: blur(14px); -webkit-backdrop-filter: blur(14px); opacity:0; transition: opacity .16s ease;}
    .modal.open .backdrop{opacity:1}
    .sheet{
      position:absolute;
      left: 12px; right: 12px; bottom: 12px;
      border-radius: var(--r);
      background: rgba(255,255,255,.94);
      border: 1px solid rgba(11,18,32,.10);
      box-shadow: 0 28px 80px rgba(16,24,40,.26);
      padding: 12px;
      transform: translateY(16px);
      opacity:0;
      transition: transform .20s cubic-bezier(.2,.9,.2,1), opacity .14s ease;
    }
    .modal.open .sheet{transform: translateY(0); opacity: 1;}
    .handle{width:42px; height:5px; border-radius:999px; background: rgba(11,18,32,.14); margin: 2px auto 10px;}
    .title{font-weight: 1200; font-size: 16px; margin-bottom: 4px;}
    .subt{font-size: 12px; color: rgba(11,18,32,.62); font-weight: 900; line-height:1.35;}
    .row2{display:flex; gap: 10px; align-items:center; margin-top: 10px;}
    .row2 input{
      flex:1;
      padding: 12px 12px;
      border-radius: 16px;
      border: 1px solid rgba(11,18,32,.14);
      background: rgba(255,255,255,.85);
      font-size: 16px;
      font-weight: 900;
      outline:none;
    }
    .row2 input:focus{border-color: rgba(59,130,246,.40); box-shadow: 0 0 0 6px rgba(59,130,246,.12)}
    .warn{
      margin-top: 10px;
      border-radius: 16px;
      padding: 10px 12px;
      border: 1px solid rgba(245,158,11,.22);
      background: rgba(245,158,11,.10);
      color: rgba(11,18,32,.78);
      font-weight: 900;
      font-size: 12px;
      line-height:1.35;
    }

    /* Admin-only visibility */
    body.adminLocked .adminOnly{display:none !important;}

    /* Print */
    @media print{
      header, .mNav, .noPrint{display:none !important;}
      body{background:white;}
      .shell{padding:0}
      .card{break-inside: avoid;}
    }
  

/* ===== Card UI (restored: segmented stages) ===== */
#cardGrid.grid{
  padding: 12px;
  display:grid;
  grid-template-columns: repeat(2, minmax(0,1fr));
  gap: 10px;
}
@media (max-width: 760px){ #cardGrid.grid{grid-template-columns:1fr} }

.card{
  background: linear-gradient(180deg, #fff, rgba(255,255,255,.92));
  border:1px solid rgba(11,18,32,.08);
  border-radius: 22px;
  box-shadow: 0 14px 30px rgba(16,24,40,.10);
  padding: 12px;
  cursor:pointer;
  transition: .14s ease;
  position:relative;
  overflow:hidden;
}
.card:hover{transform: translateY(-2px)}
.cardTop{display:flex; align-items:flex-start; justify-content:space-between; gap:10px; margin-bottom:10px;}
.name{font-size: 18px; font-weight:1000; line-height:1.15; margin:0;}
.kpi{text-align:left; min-width: 140px;}
.kpi .l{font-size:11px; font-weight:1000; color:rgba(11,18,32,.45)}
.kpi .v{font-size:16px; font-weight:1000; margin-top:4px}
.kpi .v strong{font-size:18px}
.meta{display:flex; flex-wrap:wrap; gap:8px; margin-bottom:10px;}
.pill{display:inline-flex; align-items:center; gap:8px; padding:7px 9px; border-radius:999px; border:1px solid rgba(11,18,32,.08); background: rgba(248,250,252,.75); font-size:11px; font-weight:1000; color: rgba(11,18,32,.75);}
.pill span{color: rgba(11,18,32,.45); font-weight:900}
.barWrap{margin-top:8px}
.bar{height: 14px; border-radius: 999px; overflow:hidden; border:1px solid rgba(11,18,32,.08); background: #f3f4f6; display:flex;}
.segm{height:100%}
.legend{display:flex; flex-wrap:wrap; gap:8px; margin-top:9px}
.leg{display:inline-flex; align-items:center; gap:8px; font-size:11px; font-weight:1000; color: rgba(11,18,32,.72);}
.dot{width:10px; height:10px; border-radius:999px; background:#111827}

/* ===== Detail restored blocks ===== */
.hero{padding: 4px 0 2px;}
.heroTitle{font-size:18px; font-weight:1100;}
.heroSub{font-size:12px; color: rgba(11,18,32,.62); margin-top:4px;}
.heroKpis{display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:10px; margin-top:10px;}
@media (max-width: 760px){ .heroKpis{grid-template-columns:1fr} }
.tile{background: rgba(255,255,255,.86); border:1px solid rgba(11,18,32,.10); border-radius:18px; padding:12px;}
.tK{font-size:11px; font-weight:1000; color: rgba(11,18,32,.55)}
.tV{font-size:18px; font-weight:1100; margin-top:6px}
.tVSmall{font-size:14px}
.tS{font-size:12px; color: rgba(11,18,32,.62); margin-top:6px}
.muted{color: rgba(11,18,32,.55); font-weight:1000}

.bigCard{background: rgba(255,255,255,.86); border:1px solid rgba(11,18,32,.10); border-radius:22px; padding:12px;}
.bigTop{display:flex; align-items:flex-start; justify-content:space-between; gap:12px; flex-wrap:wrap;}
.bigK{font-size:12px; font-weight:1100; color: rgba(11,18,32,.62)}
.bigNote{font-size:12px; color: rgba(11,18,32,.62)}
.bigBar{margin-top:10px; height: 16px; border-radius:999px; overflow:hidden; border:1px solid rgba(11,18,32,.10); background:#f3f4f6; display:flex;}
.afterPlan{margin-top:10px; font-size:12px; color: rgba(11,18,32,.62)}

.stageGrid{display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:10px; }
@media (max-width: 760px){ .stageGrid{grid-template-columns:1fr} }
.stage{background: rgba(255,255,255,.86); border:1px solid rgba(11,18,32,.10); border-radius:22px; padding:12px; position:relative; overflow:hidden;}
.stage::before{content:""; position:absolute; inset:0; background: linear-gradient(180deg, color-mix(in oklab, var(--stageColor) 12%, transparent), transparent); pointer-events:none;}
.stage .row{display:flex; align-items:flex-start; justify-content:space-between; gap:10px;}
.stage .row b{font-size:13px; font-weight:1100;}
.stage .row span{font-size:11px; color: rgba(11,18,32,.62); font-weight:900;}
.lbl{font-size:11px; color: rgba(11,18,32,.55); font-weight:1000; margin-top:10px;}
.amt{font-size:22px; font-weight:1100; margin-top:4px;}
.cur{font-size:12px; color: rgba(11,18,32,.55); font-weight:900; margin-right:6px;}
.mini{font-size:12px; color: rgba(11,18,32,.62); margin-top:6px}

.fullGrid{display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:10px;}
@media (max-width: 760px){ .fullGrid{grid-template-columns:1fr} }
.fullCard{background: rgba(255,255,255,.86); border:1px solid rgba(11,18,32,.10); border-radius:22px; padding:12px;}
.fullH{font-size:12px; font-weight:1100; color: rgba(11,18,32,.62); margin-bottom:10px}
.fullRow{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:8px 0; border-bottom:1px dashed rgba(11,18,32,.10); font-size:13px;}
.fullRow:last-child{border-bottom:none}
.fullRow.total{border-top:1px solid rgba(11,18,32,.10); padding-top:12px; margin-top:6px; font-weight:1100}

</style>
</head>

<body class="adminLocked">
<header>
  <div class="topBar">
    <div class="brand" id="brand">
      <div class="mark" aria-hidden="true"></div>
      <div class="t">
        <b>Ù„ÙˆØ­Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª</b>
        <span id="subtitle">Ø¹Ø±Ø¶ Ø³Ø±ÙŠØ¹ â€¢ ØªÙØ§ØµÙŠÙ„ ÙˆØ§Ø¶Ø­Ø©</span>
      </div>
    </div>

    <div class="right">
      <div class="onlineBadge" title="Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ÙŠÙ† Ø§Ù„Ø¢Ù†">
        <span class="dot" aria-hidden="true"></span>
        <span class="lbl">Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ÙŠÙ†</span>
        <span class="num" id="onlineCount">â€”</span>
      </div>

      <div class="chip" title="Ø­Ø§Ù„Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª">
        <span class="k">Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«</span>
        <span class="v" id="lastSync">â€”</span>
      </div>

      <button class="btn" id="btnRefresh" title="Ø¬Ù„Ø¨ Ø£Ø­Ø¯Ø« Ù†Ø³Ø®Ø©">ØªØ­Ø¯ÙŠØ«</button>
      <button class="btn primary adminOnly" id="btnPublish" title="Ù†Ø´Ø± Ù„Ù„Ø¬Ù…ÙŠØ¹">Ù†Ø´Ø±</button>
    </div>
  </div>
</header>

<div class="shell">
  <div class="toolbar">
    <div class="seg noPrint" id="viewSeg">
      <button data-view="board" class="active">Ù„ÙˆØ­Ø©</button>
      <button data-view="list">Ù‚Ø§Ø¦Ù…Ø©</button>
      <button data-view="manage" class="adminOnly">Ø¥Ø¯Ø§Ø±Ø©</button>
      <button data-view="settings" class="adminOnly">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
    </div>

    <div class="search noPrint">
      <span style="opacity:.7">ğŸ”</span>
      <input id="q" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…â€¦" />
    </div>

    <div class="filters noPrint">
      <select id="filterCompound" class="select" aria-label="ØªØµÙÙŠØ© Ø§Ù„Ù…Ø¬Ù…Ø¹">
        <option value="">ÙƒÙ„ Ø§Ù„Ù…Ø¬Ù…Ø¹Ø§Øª</option>
      </select>
      <select id="filterDawr" class="select" aria-label="ØªØµÙÙŠØ© Ø§Ù„Ø¯ÙˆØ±">
        <option value="">ÙƒÙ„ Ø§Ù„Ø¯ÙˆØ±</option>
      </select>
      <select id="sortBy" class="select" aria-label="ØªØ±ØªÙŠØ¨">
        <option value="name">Ø§Ù„Ø§Ø³Ù…</option>
        <option value="gap">ÙØ¬ÙˆØ© Ø§Ù„ØªØºØ·ÙŠØ©</option>
        <option value="total">Ø§Ù„ØªÙƒÙ„ÙØ©</option>
        <option value="students">Ø§Ù„Ø·Ù„Ø§Ø¨</option>
      </select>
    </div>
  </div>

  <!-- BOARD -->
  <section class="view active" id="view_board">
    <div class="grid" id="cardGrid"></div>
  </section>

  <!-- LIST -->
  <section class="view" id="view_list">
    <div class="tableWrap">
      <table>
        <thead>
          <tr>
            <th style="min-width:160px">Ø§Ù„Ø§Ø³Ù…</th>
            <th style="min-width:110px">Ø§Ù„Ù…Ø¬Ù…Ø¹</th>
            <th style="min-width:90px">Ø§Ù„Ø¯ÙˆØ±</th>
            <th style="min-width:110px">Ø§Ù„ØªÙƒÙ„ÙØ©</th>
            <th style="min-width:110px">Ø§Ù„Ù…ØºØ·Ù‘Ù‰</th>
            <th style="min-width:90px">Ø§Ù„Ø·Ù„Ø§Ø¨</th>
            <th style="min-width:120px">Ù‡Ø¯Ù Ø§Ù„Ù…Ø­ÙØ¸Ø©</th>
            <th style="min-width:110px">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </section>

  <!-- MANAGE (admin) -->
  <section class="view adminOnly" id="view_manage">
    <div class="tableWrap" style="padding: 12px;">
      <div class="row" style="gap:10px; flex-wrap:wrap;">
        <div style="flex:1; min-width: 220px;">
          <div class="k" style="margin-bottom:6px;">Ø§Ø³ØªÙŠØ±Ø§Ø¯ CSV</div>
          <div class="rowBtns">
            <input type="file" id="csvFile" accept=".csv,text/csv" class="btn" style="padding:10px 12px; border-radius:999px; width: 210px;" />
            <button class="btn" id="btnCsvPaste">Ù„ØµÙ‚ CSV</button>
          </div>
          <div class="k" style="margin-top:8px;">ÙŠØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ (ÙˆÙ…Ø¹Ù‡Ø§ Ø§Ø®ØªÙŠØ§Ø± ÙŠØ¯ÙˆÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©).</div>
        </div>

        <div style="flex:1; min-width: 220px;">
          <div class="k" style="margin-bottom:6px;">Ø¥Ø¶Ø§ÙØ© Ø¨Ø·Ø§Ù‚Ø©</div>
          <div class="rowBtns">
            <button class="btn primary" id="btnAddCard">Ø¥Ø¶Ø§ÙØ©</button>
            <button class="btn" id="btnExportJson">ØªØµØ¯ÙŠØ± JSON (Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©)</button>
            <button class="btn" id="btnImportJson">Ø§Ø³ØªÙŠØ±Ø§Ø¯ JSON</button>
            <input type="file" id="jsonFile" accept="application/json" style="display:none" />
          </div>
        </div>
      </div>

      <div class="warn" id="dirtyWarn" style="display:none;">
        Ù„Ø¯ÙŠÙƒ ØªØºÙŠÙŠØ±Ø§Øª ØºÙŠØ± Ù…Ù†Ø´ÙˆØ±Ø©. Ø§Ø¶ØºØ· <b>Ù†Ø´Ø±</b> Ù„ÙŠØ´Ø§Ù‡Ø¯ Ø§Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©.
      </div>

      <div id="importPreview" style="margin-top:12px; display:none;"></div>
    </div>

    <div class="tableWrap" style="margin-top:12px; padding:12px;">
      <div class="row" style="gap: 10px; flex-wrap:wrap;">
        <div style="flex:1; min-width: 240px;">
          <div class="k" style="margin-bottom:6px;">Ø§Ù„Ù…Ø±Ø§Ø­Ù„ (Ù…Ø±ÙƒØ²ÙŠØ©)</div>
          <div class="k">Ù‡Ø°Ù‡ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª ØªØ¸Ù‡Ø± ÙÙ‚Ø· Ø¨Ø¹Ø¯ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ù…Ø² 111.</div>
        </div>
        <div class="rowBtns">
          <button class="btn adminOnly" id="btnAddStage">Ø¥Ø¶Ø§ÙØ© Ù…Ø±Ø­Ù„Ø©</button>
        </div>
      </div>
      <div id="stageEditor" class="adminOnly" style="margin-top:12px;"></div>
    </div>
  </section>

  <!-- SETTINGS (admin) -->
  <section class="view adminOnly" id="view_settings">
    <div class="tableWrap" style="padding: 12px;">
      <div class="row" style="gap:10px; flex-wrap:wrap;">
        <div style="flex:1; min-width: 260px;">
          <div class="k" style="margin-bottom:6px;">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø­ÙˆØ±ÙŠØ©</div>
          <div class="k">ÙŠÙ…ÙƒÙ†Ùƒ Ø¶Ø¨Ø· Ù‡Ø¯Ù Ø§Ù„Ù…Ø­ÙØ¸Ø© ÙƒÙ†Ø³Ø¨Ø© Ù…Ù† Ø§Ù„ØªÙƒÙ„ÙØ©.</div>
        </div>
      </div>

      <div class="row" style="gap:10px; margin-top:10px; flex-wrap:wrap;">
        <div style="flex:1; min-width:240px;">
          <div class="k">Ù†Ø³Ø¨Ø© Ù‡Ø¯Ù Ø§Ù„Ù…Ø­ÙØ¸Ø© Ù…Ù† Ø§Ù„ØªÙƒÙ„ÙØ© (Ù…Ø«Ø§Ù„ 1 = 100%)</div>
          <input class="edit" id="setGoalRatio" type="number" step="0.01" placeholder="Ù…Ø«Ø§Ù„: 1" />
        </div>
        <div style="flex:1; min-width:240px;">
          <div class="k">Ù†Ø³Ø¨Ø© Ø§Ù„ØªØºØ·ÙŠØ© (Ø¥Ø°Ø§ ØªØ¨ÙŠ ØªØ«Ø¨ÙŠØªÙ‡Ø§ Ù…Ø±ÙƒØ²ÙŠÙ‹Ø§) (0..1)</div>
          <input class="edit" id="setCoverageRatio" type="number" step="0.01" placeholder="ÙØ§Ø±Øº = Ø­Ø³Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª" />
        </div>
      </div>
        <div style="flex:1; min-width:240px;">
          <div class="k">Ø§Ù„Ø¹Ø§Ø¦Ø¯ Ø§Ù„Ø³Ù†ÙˆÙŠ Ù„Ù„Ù…Ø­ÙØ¸Ø© (%)</div>
          <input class="edit" id="setReturnRate" type="number" step="0.1" placeholder="Ù…Ø«Ø§Ù„: 9" />
        </div>
        <div style="flex:1; min-width:240px;">
          <div class="k">Ù†Ø·Ø§Ù‚ Ù‡Ø¯Ù Ø§Ù„Ù…Ø­ÙØ¸Ø©</div>
          <select class="edit" id="setGoalScope">
            <option value="remaining">ØªØºØ·ÙŠØ© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„ØªØºØ·ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</option>
            <option value="total">ØªØºØ·ÙŠØ© Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©</option>
          </select>
        </div>


      <div class="rowBtns" style="margin-top:10px;">
        <button class="btn primary adminOnly" id="btnSaveSettings">Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
        <button class="btn adminOnly" id="btnLock">Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª</button>
      </div>
    </div>
  </section>

  <!-- Detail Page -->
  <section id="detailPage" class="detailPage" aria-hidden="true">
    <div class="detailTop">
      <button class="btn small" id="detailBack">Ø±Ø¬ÙˆØ¹</button>
      <div class="detailTitle" id="detailTitle">Ø§Ù„ØªÙØ§ØµÙŠÙ„</div>
      <button class="btn small primary adminOnly" id="detailPublish">Ù†Ø´Ø±</button>
    </div>

    <div class="detailTabs" id="detailTabs">
      <button class="detailTab active" data-tab="summary">Ù…Ù„Ø®Øµ</button>
      <button class="detailTab" data-tab="stages">Ø§Ù„Ù…Ø±Ø§Ø­Ù„</button>
      <button class="detailTab" data-tab="full">ÙƒØ§Ù…Ù„</button>
    </div>

    <div class="detailKPIWrap" id="detailKPIWrap"></div>

    <div class="detailBody" id="detailBody">
      <div class="detailPanel active" id="detailPanelSummary"></div>
      <div class="detailPanel" id="detailPanelStages"></div>
      <div class="detailPanel" id="detailPanelFull"></div>
      <div class="hint">Ø§Ø³Ø­Ø¨ Ù„Ù„Ø£Ø³ÙÙ„ Ù„Ù„Ø¥ØºÙ„Ø§Ù‚ â€¢ Ø£Ùˆ Ø§Ø³Ø­Ø¨ Ù…Ù† Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø£ÙŠØ³Ø± Ù„Ù„Ø±Ø¬ÙˆØ¹</div>
    </div>
  </section>

</div>

<!-- Mobile nav -->
<nav class="mNav noPrint">
  <div class="seg" id="mSeg">
    <button data-view="board" class="active">Ù„ÙˆØ­Ø©</button>
    <button data-view="list">Ù‚Ø§Ø¦Ù…Ø©</button>
    <button data-view="manage" class="adminOnly">Ø¥Ø¯Ø§Ø±Ø©</button>
    <button data-view="settings" class="adminOnly">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
  </div>
</nav>

<!-- Admin unlock modal -->
<div class="modal noPrint" id="adminModal" aria-hidden="true">
  <div class="backdrop" id="adminBackdrop"></div>
  <div class="sheet">
    <div class="handle" aria-hidden="true"></div>
    <div class="title">Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„</div>
    <div class="subt">Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙˆØ§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª.</div>
    <div class="row2">
      <input id="adminPass" inputmode="numeric" autocomplete="one-time-code" placeholder="â€¢â€¢â€¢" maxlength="6" />
      <button class="btn primary" id="adminUnlock">Ø¯Ø®ÙˆÙ„</button>
    </div>
    <div class="rowBtns" style="margin-top:10px; justify-content:space-between;">
      <button class="btn" id="adminHide">Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª</button>
      <span class="chip"><span class="k">Ø§Ù„Ø­Ø§Ù„Ø©</span><span class="v" id="adminState">Ù…Ø®ÙÙŠ</span></span>
    </div>
  </div>
</div>

<!-- Conflict modal -->
<div class="modal noPrint" id="conflictModal" aria-hidden="true">
  <div class="backdrop" id="conflictBackdrop"></div>
  <div class="sheet">
    <div class="handle" aria-hidden="true"></div>
    <div class="title">ØªØ¹Ø§Ø±Ø¶ ÙÙŠ Ø§Ù„Ù†Ø³Ø®</div>
    <div class="subt">ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù†Ø³Ø®Ø© Ø£Ø­Ø¯Ø« Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù…ØŒ Ø¨ÙŠÙ†Ù…Ø§ Ù„Ø¯ÙŠÙƒ ØªØºÙŠÙŠØ±Ø§Øª Ù…Ø­Ù„ÙŠØ©. Ø§Ø®ØªØ± Ø§Ù„ØªØµØ±Ù:</div>
    <div class="warn" id="conflictInfo">â€”</div>
    <div class="rowBtns" style="margin-top:10px;">
      <button class="btn" id="btnKeepRemote">Ø§Ø¹ØªÙ…Ø§Ø¯ Ù†Ø³Ø®Ø© Ø§Ù„Ø®Ø§Ø¯Ù…</button>
      <button class="btn primary adminOnly" id="btnKeepLocal">Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨ØªØ¹Ø¯ÙŠÙ„Ø§ØªÙŠ (Ø«Ù… Ù†Ø´Ø±)</button>
      <button class="btn" id="btnExportLocal">ØªØµØ¯ÙŠØ± ØªØ¹Ø¯ÙŠÙ„Ø§ØªÙŠ JSON</button>
    </div>
  </div>
</div>

<script>
/* =============================
   Jony Ive-style rebuild (v10)
   - Keeps previous capabilities:
     PWA, Presence, Admin lock (111), Manual Refresh, Publish, Stages central,
     Board/List, Detail page tabs + gestures, Filters, Deep links.
   - Better data handling:
     Schema+Validation, Dirty state, Conflict-aware sync (base_rev), Draft-first UX.
============================= */

(function(){
  // ===== PWA: Service Worker (offline shell) =====
  try{
    if("serviceWorker" in navigator){
      window.addEventListener("load", ()=>navigator.serviceWorker.register("./sw.js").catch(()=>{}));
    }
  }catch(e){}

  // ===== Utilities =====
  const $ = (s, p=document)=>p.querySelector(s);
  const $$ = (s, p=document)=>Array.from(p.querySelectorAll(s));
  const now = ()=>Date.now();

  function escapeHtml(s){
    return String(s??"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
  }
  function fmtInt(n){
    const x = Number(n||0);
    if(!isFinite(x)) return "0";
    try{ return new Intl.NumberFormat("ar-SA").format(Math.round(x)); }catch(e){ return String(Math.round(x)); }
  }
  function fmtMoney(n){ return fmtInt(n); }
  function pct01(x){
    const n = Number(x);
    if(!isFinite(n)) return "â€”";
    const p = n*100;
    return (p<10 ? p.toFixed(1) : p.toFixed(0)) + "%";
  }
  function uid(prefix="id"){
    try{ return prefix+"_"+crypto.randomUUID(); }catch(e){ return prefix+"_"+Math.random().toString(16).slice(2)+now(); }
  }
  function clamp(n,a,b){ return Math.max(a, Math.min(b, n)); }

  // ===== Remote endpoints (no UI) =====
  function remoteBase(){ return location.origin + "/.netlify/functions"; }
  function getUrl(){ return remoteBase() + "/compounds-get"; }
  function saveUrl(){ return remoteBase() + "/compounds-save"; }

  // ===== State + Persistence =====
  const LS_KEY = "compound_v10_local_state";
  const ADMIN_KEY = "compound_admin_unlocked_v1";
  const SID_KEY = "compound_presence_sid_v1";

  let state = defaultState();
  let remoteSnapshot = null;   // last fetched from server
  let dirty = false;           // local changes not published
  let selectedId = null;

  function defaultState(){
    return {
      meta: { schema: 2, updated_at: 0, rev: "init" },
      settings: {
        goal_ratio: 1,        // portfolio goal as ratio of total
        coverage_ratio: null  // if set, overrides card.covered/total display
      },
      stages: [
        { id: uid("st"), name: "Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰", target_ratio: 0.25, color: "#3B82F6" },
        { id: uid("st"), name: "Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©", target_ratio: 0.25, color: "#22C55E" },
        { id: uid("st"), name: "Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø«Ø§Ù„Ø«Ø©", target_ratio: 0.25, color: "#F59E0B" },
        { id: uid("st"), name: "Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø±Ø§Ø¨Ø¹Ø©", target_ratio: 0.25, color: "#A855F7" }
      ],
      cards: []
    };
  }

  function migrate(raw){
    // Accept prior schema 1 or missing
    const s = raw && typeof raw==="object" ? raw : {};
    const schema = Number(s?.meta?.schema || 1);

    if(schema === 1){
      // Convert old stages: might have {target} amounts. We'll keep by mapping to ratio if total exists is per-card. Here use ratios if present; else equal.
      const settings = s.settings || {};
      const stages = Array.isArray(s.stages) ? s.stages.map((st,i)=>({
        id: st.id || uid("st"),
        name: st.name || ("Ù…Ø±Ø­Ù„Ø© " + (i+1)),
        target_ratio: (typeof st.target_ratio==="number") ? st.target_ratio : null,
        target: (typeof st.target==="number") ? st.target : null,
        color: st.color || null
      })) : [];

      const cards = Array.isArray(s.cards) ? s.cards.map(c=>({
        id: String(c.id || uid("c")),
        name: String(c.name||""),
        total: Number(c.total||0)||0,
        covered: Number(c.covered||0)||0,
        students: Number(c.students||0)||0,
        compoundCategory: String(c.compoundCategory||c.compound||""),
        dawr: String(c.dawr||""),
        // legacy extras if exist
        admin: Number(c.admin||c.adminCost||0)||0,
        halaqat: Number(c.halaqat||0)||0,
        programs: Number(c.programs||0)||0,
      })) : [];

      return {
        meta: { schema: 2, updated_at: Number(s?.meta?.updated_at||0)||0, rev: String(s?.meta?.rev||"migrated") },
        settings: {
          goal_ratio: Number(settings.goal_ratio ?? settings.goalRatio ?? 1) || 1,
          coverage_ratio: (settings.coverage_ratio==null || settings.coverage_ratio==="") ? null : Number(settings.coverage_ratio)
        },
        stages: normalizeStagesV2(stages),
        cards: normalizeCardsV2(cards)
      };
    }

    // schema 2
    return {
      meta: { schema: 2, updated_at: Number(s?.meta?.updated_at||0)||0, rev: String(s?.meta?.rev||"unknown") },
      settings: {
        goal_ratio: Number(s?.settings?.goal_ratio ?? 1) || 1,
        coverage_ratio: (s?.settings?.coverage_ratio==null || s?.settings?.coverage_ratio==="") ? null : Number(s?.settings?.coverage_ratio)
      },
      stages: normalizeStagesV2(s?.stages || []),
      cards: normalizeCardsV2(s?.cards || [])
    };
  }

  function normalizeStagesV2(stages){
  const arr = Array.isArray(stages) ? stages : [];
  let cumulative = 0;
  const cleaned = arr.map((st,i)=>{
    const id = String(st.id || uid("st"));
    const name = String(st.name || ("Ø§Ù„Ù…Ø±Ø­Ù„Ø© " + (i+1)));
    const period = String(st.period || "");
    // target_pct is cumulative coverage after this stage (0..100)
    let target_pct = st.target_pct;
    if(target_pct==null || target_pct===""){
      if(st.target_ratio!=null && st.target_ratio!==""){
        cumulative += clamp(Number(st.target_ratio)||0, 0, 1.5) * 100;
        target_pct = cumulative;
      } else if(st.target!=null && st.target!==""){
        // fallback: if someone pasted percent into "target"
        target_pct = Number(st.target)||0;
      } else {
        // default ladder
        target_pct = [65,80,90,100][i] ?? 100;
      }
    }
    target_pct = clamp(Number(target_pct)||0, 0, 100);
    cumulative = Math.max(cumulative, target_pct);

    const color = String(st.color || ["#2563eb","#16a34a","#f59e0b","#a855f7","#ef4444","#14b8a6","#0ea5e9"][i%7]);
    return { id, name, period, target_pct, color };
  });

  if(!cleaned.length){
    return [
      { id: uid("st"), name:"Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰", period:"Ø®Ù„Ø§Ù„ Ø±Ù…Ø¶Ø§Ù†", target_pct:65, color:"#2563eb" },
      { id: uid("st"), name:"Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©", period:"Ø¨Ø¹Ø¯ Ø±Ù…Ø¶Ø§Ù†", target_pct:80, color:"#16a34a" },
      { id: uid("st"), name:"Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø«Ø§Ù„Ø«Ø©", period:"Ù„Ø§Ø­Ù‚Ø§Ù‹", target_pct:90, color:"#f59e0b" },
      { id: uid("st"), name:"Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø±Ø§Ø¨Ø¹Ø©", period:"Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø®Ø·Ø©", target_pct:100, color:"#a855f7" }
    ];
  }

  // ensure ascending by target_pct
  cleaned.sort((a,b)=>a.target_pct-b.target_pct);
  return cleaned;
}


function calcPortfolioGoal(total, coveredAmt){
  const ratePct = parseNumber(state.settings.return_rate ?? 9); // % Ø³Ù†ÙˆÙŠ
  const rate = Number.isFinite(ratePct) ? ratePct/100 : 0;
  const scope = (state.settings.goal_scope ?? "remaining"); // total | remaining
  const amountToCover = (scope==="total") ? Math.max(0,total) : Math.max(0,total - coveredAmt);
  if(rate<=0) return {goal: NaN, amountToCover, rate};
  return {goal: amountToCover / rate, amountToCover, rate};
}
function stageGoal(coverAmount, rate){
  if(!rate || rate<=0) return NaN;
  return Math.max(0, coverAmount) / rate;
}
function stageColor(idx){
  const palette = ["#111827","#2563eb","#16a34a","#f59e0b","#ef4444","#a855f7","#14b8a6","#0ea5e9","#f97316","#22c55e"];
  return palette[idx % palette.length];
}
function normalizeStages(){
  // backward compatibility for old fields target_ratio / target
  state.stages = (state.stages||[]).map((s,i)=>{
    const out = {...s};
    if(out.target_pct==null){
      if(out.target_ratio!=null) out.target_pct = clamp(parseNumber(out.target_ratio)*100,0,100);
      else if(out.target!=null && Number.isFinite(parseNumber(out.target))) out.target_pct = clamp(parseNumber(out.target),0,100); // treat as pct if user used old field
      else out.target_pct = [65,80,90,100][i] ?? 100;
    }
    if(out.name==null) out.name = `Ø§Ù„Ù…Ø±Ø­Ù„Ø© ${i+1}`;
    if(out.period==null) out.period = "";
    return out;
  });
}
function computeStagePlan(card){
  const total = Number(card.total||0)||0;
  const coveredNow = clamp(Number(card.covered||0)||0, 0, total);
  const {rate} = calcPortfolioGoal(total, coveredNow);

  const sorted = (state.stages||[])
    .map((s,i)=>({ ...s, t: clamp(parseNumber(s.target_pct),0,100)}))
    .sort((a,b)=>a.t-b.t);

  let current = coveredNow;
  const plans = sorted.map((s, idx)=>{
    const desired = total * (s.t/100);
    const inc = Math.max(0, Math.min(total, desired) - current);
    current += inc;
    return {
      name:(s.name??`Ù…Ø±Ø­Ù„Ø© ${idx+1}`).toString(),
      period:(s.period??"").toString(),
      targetPct: s.t,
      incrementAmount: inc,
      goal: stageGoal(inc, rate),
      color: (s.color??stageColor(idx)),
    };
  });

  const afterCovered = Math.min(total, current);
  const remain = Math.max(0, total - afterCovered);
  return {total, coveredNow, plans, afterCovered, remain, rate};
}



  function normalizeCardsV2(cards){
    const arr = Array.isArray(cards) ? cards : [];
    return arr.map((c)=>({
      id: String(c.id || uid("c")),
      name: String(c.name || ""),
      total: Math.max(0, Number(c.total)||0),
      covered: Math.max(0, Number(c.covered)||0),
      students: Math.max(0, Number(c.students)||0),
      compoundCategory: String(c.compoundCategory || ""),
      dawr: String(c.dawr || ""),
      admin: Math.max(0, Number(c.admin)||0),
      halaqat: Math.max(0, Number(c.halaqat)||0),
      programs: Math.max(0, Number(c.programs)||0),
    }));
  }

  function loadLocal(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return null;
      return migrate(JSON.parse(raw));
    }catch(e){ return null; }
  }
  function saveLocal(){
    try{
      localStorage.setItem(LS_KEY, JSON.stringify(state));
    }catch(e){}
  }

  function markDirty(on=true){
    dirty = !!on;
    $("#dirtyWarn") && ($("#dirtyWarn").style.display = dirty ? "block" : "none");
    $("#subtitle").textContent = dirty ? "Ù„Ø¯ÙŠÙƒ ØªØºÙŠÙŠØ±Ø§Øª ØºÙŠØ± Ù…Ù†Ø´ÙˆØ±Ø©" : "Ø¹Ø±Ø¶ Ø³Ø±ÙŠØ¹ â€¢ ØªÙØ§ØµÙŠÙ„ ÙˆØ§Ø¶Ø­Ø©";
  }

  function setLastSync(ts){
    const el = $("#lastSync");
    if(!el) return;
    if(!ts){ el.textContent = "â€”"; return; }
    const d = new Date(ts);
    try{
      el.textContent = d.toLocaleString("ar-SA", { hour:"2-digit", minute:"2-digit", day:"2-digit", month:"2-digit" });
    }catch(e){
      el.textContent = d.toISOString().slice(0,16).replace("T"," ");
    }
  }

  // ===== Presence =====
  function getSid(){
    try{
      let sid = localStorage.getItem(SID_KEY);
      if(!sid){
        sid = (crypto?.randomUUID?.() || ("sid_" + Math.random().toString(16).slice(2) + now()));
        localStorage.setItem(SID_KEY, sid);
      }
      return sid;
    }catch(e){ return "sid_" + Math.random().toString(16).slice(2) + now(); }
  }
  async function presencePing(){
    try{
      await fetch(remoteBase()+"/presence-ping", {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        cache:"no-store",
        body: JSON.stringify({ sid: getSid(), t: now() })
      });
    }catch(e){}
  }
  async function presenceCount(){
    try{
      const res = await fetch(remoteBase()+"/presence-count", { cache:"no-store" });
      const j = await res.json();
      $("#onlineCount").textContent = (j?.count ?? "â€”");
    }catch(e){ $("#onlineCount").textContent = "â€”"; }
  }
  function startPresence(){
    presencePing(); presenceCount();
    setInterval(presencePing, 20000);
    setInterval(presenceCount, 25000);
    document.addEventListener("visibilitychange", ()=>{ if(!document.hidden){ presencePing(); presenceCount(); }});
    window.addEventListener("focus", ()=>{ presencePing(); presenceCount(); });
  }

  // ===== Admin lock (111) =====
  function isUnlocked(){
    try{ return localStorage.getItem(ADMIN_KEY)==="1"; }catch(e){ return false; }
  }
  function applyLockState(){
    const unlocked = isUnlocked();
    document.body.classList.toggle("adminLocked", !unlocked);
    $("#adminState").textContent = unlocked ? "Ù…ÙØ¹Ù„" : "Ù…Ø®ÙÙŠ";
    // Keep active view valid
    if(!unlocked){
      const v = currentView();
      if(v==="manage" || v==="settings") switchView("board");
    }
  }
  function openAdminModal(){
    $("#adminModal").classList.add("open");
    $("#adminModal").setAttribute("aria-hidden","false");
    try{ $("#adminPass").value=""; $("#adminPass").focus(); }catch(e){}
  }
  function closeAdminModal(){
    $("#adminModal").classList.remove("open");
    $("#adminModal").setAttribute("aria-hidden","true");
  }
  function unlockWith(code){
    if(String(code||"").trim()==="111"){
      try{ localStorage.setItem(ADMIN_KEY,"1"); }catch(e){}
      applyLockState();
      closeAdminModal();
      toast("ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª");
      return true;
    }
    toast("Ø±Ù…Ø² ØºÙŠØ± ØµØ­ÙŠØ­");
    return false;
  }
  function lockNow(){
    try{ localStorage.removeItem(ADMIN_KEY); }catch(e){}
    applyLockState();
    closeAdminModal();
    toast("ØªÙ… Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª");
  }

  // Gesture: triple-tap or long press brand
  (function(){
    const brand = $("#brand");
    if(!brand) return;
    let tap=0, tmr=null, press=null;
    brand.addEventListener("touchstart", ()=>{ press=setTimeout(openAdminModal, 650); }, {passive:true});
    brand.addEventListener("touchend", ()=>{ if(press){clearTimeout(press); press=null;} }, {passive:true});
    brand.addEventListener("click", ()=>{
      tap++;
      if(tmr) clearTimeout(tmr);
      tmr=setTimeout(()=>tap=0, 650);
      if(tap>=3){ tap=0; openAdminModal(); }
    });
  })();

  $("#adminBackdrop").addEventListener("click", closeAdminModal);
  $("#adminUnlock").addEventListener("click", ()=>unlockWith($("#adminPass").value));
  $("#adminPass").addEventListener("keydown", (e)=>{ if(e.key==="Enter") unlockWith($("#adminPass").value); });
  $("#adminHide").addEventListener("click", lockNow);

  // ===== Toast (tiny, minimal) =====
  let toastT = null;
  function toast(msg){
    let el = $("#toast");
    if(!el){
      el = document.createElement("div");
      el.id="toast";
      el.style.position="fixed";
      el.style.left="50%";
      el.style.bottom="calc(92px + var(--safeBot))";
      el.style.transform="translateX(-50%)";
      el.style.padding="10px 12px";
      el.style.borderRadius="999px";
      el.style.background="rgba(11,18,32,.92)";
      el.style.color="rgba(255,255,255,.96)";
      el.style.fontWeight="1000";
      el.style.fontSize="12px";
      el.style.boxShadow="0 18px 60px rgba(16,24,40,.22)";
      el.style.zIndex="200";
      el.style.opacity="0";
      el.style.transition="opacity .14s ease, transform .14s ease";
      document.body.appendChild(el);
    }
    el.textContent = msg;
    el.style.opacity="1";
    el.style.transform="translateX(-50%) translateY(0)";
    if(toastT) clearTimeout(toastT);
    toastT = setTimeout(()=>{
      el.style.opacity="0";
      el.style.transform="translateX(-50%) translateY(6px)";
    }, 1200);
  }

  // ===== Conflict modal =====
  function openConflict(info){
    $("#conflictInfo").innerHTML = info;
    $("#conflictModal").classList.add("open");
    $("#conflictModal").setAttribute("aria-hidden","false");
  }
  function closeConflict(){
    $("#conflictModal").classList.remove("open");
    $("#conflictModal").setAttribute("aria-hidden","true");
  }
  $("#conflictBackdrop").addEventListener("click", closeConflict);

  // ===== Sync (manual) with conflict-aware save =====
  async function fetchRemote(){
    const res = await fetch(getUrl(), { cache:"no-store" });
    if(!res.ok) throw new Error("fetch failed");
    const data = migrate(await res.json());
    // ensure server may not have rev
    if(!data.meta.rev) data.meta.rev = "srv_" + now();
    remoteSnapshot = data;
    return data;
  }

  async function pullLatest(){
    const btn = $("#btnRefresh");
    btn.disabled = true;
    const prev = btn.textContent;
    btn.textContent = "â€¦";
    try{
      const remote = await fetchRemote();
      // If local dirty and remote differs, raise conflict (do not overwrite silently)
      const remoteRev = remote?.meta?.rev;
      const localBase = state?.meta?.base_rev || state?.meta?.rev;
      const localDirty = dirty;
      const remoteNewer = (remoteRev && remoteRev !== (remoteSnapshot?.meta?.rev || remoteRev)) ? true : true; // always treat as fresh fetch

      if(localDirty && remoteRev && remoteRev !== localBase){
        // Show conflict
        openConflict(`Ù†Ø³Ø®Ø© Ø§Ù„Ø®Ø§Ø¯Ù… Ø£Ø­Ø¯Ø« Ù…Ù† Ù†Ø³Ø®ØªÙƒ Ø§Ù„Ù…Ø­Ù„ÙŠØ©.<br><br><b>Ø§Ù„Ø®Ø§Ø¯Ù…:</b> ${escapeHtml(remoteRev)}<br><b>Ù…Ø­Ù„ÙŠ (Ø£Ø³Ø§Ø³):</b> ${escapeHtml(localBase)}<br><br>Ø§Ø®ØªØ± Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ø®Ø§Ø¯Ù… Ø£Ùˆ Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨ØªØ¹Ø¯ÙŠÙ„Ø§ØªÙƒ.`);
        // Stash remote for buttons
        window.__remoteForConflict = remote;
      }else{
        // Accept remote as new local (clean)
        state = remote;
        state.meta.base_rev = remote.meta.rev;
        markDirty(false);
        saveLocal();
        renderAll();
        setLastSync(remote.meta.updated_at || now());
        toast("ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«");
      }
    }catch(e){
      toast("ØªØ¹Ø°Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ«");
    }finally{
      btn.disabled = false;
      btn.textContent = prev;
    }
  }

  async function publish(){
    if(!isUnlocked()){
      toast("Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ù…Ø®ÙÙŠØ©");
      return;
    }
    const btn = $("#btnPublish");
    btn.disabled = true;
    const prev = btn.textContent;
    btn.textContent = "â€¦";
    try{
      // Prepare payload with base_rev
      const payload = structuredClone(state);
      payload.meta = payload.meta || {};
      payload.meta.schema = 2;
      payload.meta.base_rev = payload.meta.base_rev || (remoteSnapshot?.meta?.rev || payload.meta.rev);
      payload.meta.updated_at = now();
      // local rev will be replaced by server; still send a draft rev
      payload.meta.rev = "draft_" + now();

      const res = await fetch(saveUrl(), {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        cache:"no-store",
        body: JSON.stringify(payload)
      });

      if(res.status === 409){
        const j = await res.json().catch(()=>null);
        const srv = j?.current ? migrate(j.current) : null;
        window.__remoteForConflict = srv || null;
        openConflict(`ØªØ¹Ø°Ø± Ø§Ù„Ù†Ø´Ø± Ù„Ø£Ù† Ù‡Ù†Ø§Ùƒ Ù†Ø³Ø®Ø© Ø£Ø­Ø¯Ø« Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù….<br><br>Ø§Ø¶ØºØ· <b>Ø§Ø¹ØªÙ…Ø§Ø¯ Ù†Ø³Ø®Ø© Ø§Ù„Ø®Ø§Ø¯Ù…</b> Ø£ÙˆÙ„Ø§Ù‹ Ø«Ù… Ø£Ø¹Ø¯ ØªØ·Ø¨ÙŠÙ‚ ØªØºÙŠÙŠØ±Ø§ØªÙƒØŒ Ø£Ùˆ <b>Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨ØªØ¹Ø¯ÙŠÙ„Ø§ØªÙŠ</b> Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø´Ø± Ø¨Ø¹Ø¯ Ø§Ù„Ø­Ù„.`);
        return;
      }

      if(!res.ok) throw new Error("save failed");
      const j = await res.json().catch(()=>({}));
      // Update local meta with server rev
      const newRev = j?.rev || ("srv_" + now());
      state.meta.rev = newRev;
      state.meta.base_rev = newRev;
      state.meta.updated_at = j?.updated_at || now();
      markDirty(false);
      saveLocal();
      setLastSync(state.meta.updated_at);
      toast("ØªÙ… Ø§Ù„Ù†Ø´Ø±");
    }catch(e){
      toast("ØªØ¹Ø°Ø± Ø§Ù„Ù†Ø´Ø±");
    }finally{
      btn.disabled = false;
      btn.textContent = prev;
    }
  }

  $("#btnRefresh").addEventListener("click", pullLatest);
  $("#btnPublish").addEventListener("click", publish);

  // Conflict actions
  $("#btnKeepRemote").addEventListener("click", ()=>{
    const srv = window.__remoteForConflict;
    if(srv){
      state = srv;
      state.meta.base_rev = srv.meta.rev;
      markDirty(false);
      saveLocal();
      renderAll();
      setLastSync(srv.meta.updated_at || now());
      toast("ØªÙ… Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ø®Ø§Ø¯Ù…");
    }
    closeConflict();
  });
  $("#btnKeepLocal").addEventListener("click", async ()=>{
    closeConflict();
    toast("Ø³ÙŠØªÙ… Ø§Ù„Ù†Ø´Ø±â€¦");
    await publish();
  });
  $("#btnExportLocal").addEventListener("click", ()=>{
    const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json;charset=utf-8"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "backup_local.json";
    a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href), 4000);
  });

  // ===== View switching =====
  function currentView(){
    const active = $("#viewSeg button.active");
    return active?.getAttribute("data-view") || "board";
  }
  function switchView(view){
    $$("#viewSeg button").forEach(b=>b.classList.toggle("active", b.getAttribute("data-view")===view));
    $$("#mSeg button").forEach(b=>b.classList.toggle("active", b.getAttribute("data-view")===view));
    $$(".view").forEach(v=>v.classList.remove("active"));
    const sec = $("#view_"+view);
    if(sec) sec.classList.add("active");
  }
  $("#viewSeg").addEventListener("click", (e)=>{
    const b = e.target.closest("button[data-view]");
    if(!b) return;
    const v = b.getAttribute("data-view");
    if(b.classList.contains("adminOnly") && !isUnlocked()) { toast("Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ù…Ø®ÙÙŠØ©"); return; }
    switchView(v);
  });
  $("#mSeg").addEventListener("click", (e)=>{
    const b = e.target.closest("button[data-view]");
    if(!b) return;
    const v = b.getAttribute("data-view");
    if(b.classList.contains("adminOnly") && !isUnlocked()) { toast("Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ù…Ø®ÙÙŠØ©"); return; }
    switchView(v);
  });

  // ===== Filtering + Sorting =====
  function uniqNonEmpty(arr){
    return Array.from(new Set(arr.map(s=>String(s||"").trim()).filter(Boolean))).sort((a,b)=>a.localeCompare(b,"ar"));
  }
  function refreshFilters(){
    const c = $("#filterCompound"), d = $("#filterDawr");
    const keepC = c.value, keepD = d.value;
    const compounds = uniqNonEmpty(state.cards.map(x=>x.compoundCategory));
    const dawrs = uniqNonEmpty(state.cards.map(x=>x.dawr));
    c.innerHTML = '<option value="">ÙƒÙ„ Ø§Ù„Ù…Ø¬Ù…Ø¹Ø§Øª</option>' + compounds.map(v=>`<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`).join("");
    d.innerHTML = '<option value="">ÙƒÙ„ Ø§Ù„Ø¯ÙˆØ±</option>' + dawrs.map(v=>`<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`).join("");
    c.value = compounds.includes(keepC) ? keepC : "";
    d.value = dawrs.includes(keepD) ? keepD : "";
  }
  function applyFilters(list){
    const q = ($("#q").value || "").trim();
    const qc = ($("#filterCompound").value || "").trim();
    const qd = ($("#filterDawr").value || "").trim();
    return list.filter(c=>{
      if(q && !c.name.includes(q)) return false;
      if(qc && c.compoundCategory !== qc) return false;
      if(qd && c.dawr !== qd) return false;
      return true;
    });
  }
  function sortList(list){
    const s = $("#sortBy").value;
    const arr = list.slice();
    const gap = (c)=>Math.max(0, (c.total||0) - (c.covered||0));
    if(s==="gap") arr.sort((a,b)=>gap(b)-gap(a));
    else if(s==="total") arr.sort((a,b)=>(b.total||0)-(a.total||0));
    else if(s==="students") arr.sort((a,b)=>(b.students||0)-(a.students||0));
    else arr.sort((a,b)=>String(a.name||"").localeCompare(String(b.name||""),"ar"));
    return arr;
  }

  $("#q").addEventListener("input", ()=>renderAll());
  $("#filterCompound").addEventListener("change", ()=>renderAll());
  $("#filterDawr").addEventListener("change", ()=>renderAll());
  $("#sortBy").addEventListener("change", ()=>renderAll());

  // ===== Board render =====
  function goalForCard(card){
  const total = Number(card.total||0)||0;
  const covered = clamp(Number(card.covered||0)||0,0,total);
  const {goal} = calcPortfolioGoal(total, covered);
  return Number.isFinite(goal) ? goal : 0;
}
  function coverageRatioForCard(card){
    const fixed = state.settings.coverage_ratio;
    if(fixed==null || fixed==="") return null;
    const n = Number(fixed);
    return isFinite(n) ? clamp(n,0,1.5) : null;
  }
  function cardCoverage(card){
    const total = Number(card.total||0)||0;
    const covered = Number(card.covered||0)||0;
    const fixed = coverageRatioForCard(card);
    if(total<=0) return 0;
    if(fixed!=null) return clamp(fixed,0,1.5);
    return clamp(covered/total,0,1.5);
  }

  function cardHtml(card){
  const plan = computeStagePlan(card);
  const total = plan.total;
  const pct = (amt)=> total>0 ? (amt/total*100) : 0;

  const barSegs=[
    {amount: plan.coveredNow, color:"rgba(247,168,163,1)"},
    ...plan.plans.map(p=>({amount:p.incrementAmount, color:p.color})),
    {amount: plan.remain, color:"#e5e7eb"}
  ].filter(s=>s.amount>0.0001);

  const covPct = total>0 ? (plan.coveredNow/total*100) : 0;

  return `
    <article class="card" data-id="${escapeHtml(card.id)}" role="button" tabindex="0" aria-label="${escapeHtml(card.name||"")}"
      onclick="openCard('${escapeHtml(card.id)}')" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault(); openCard('${escapeHtml(card.id)}')}">
      <div class="cardTop">
        <h3 class="name">${escapeHtml(card.name||"â€”")}</h3>
        <div class="kpi">
          <div class="l">Ø§Ù„ØªÙƒÙ„ÙØ©</div>
          <div class="v"><strong>${fmtMoney(total)}</strong><span class="sar">ï·¼</span></div>
        </div>
      </div>

      <div class="meta">
        ${card.compoundCategory ? `<span class="pill"><span>Ø§Ù„Ù…Ø¬Ù…Ø¹</span>${escapeHtml(card.compoundCategory)}</span>` : ``}
        ${card.dawr ? `<span class="pill"><span>Ø§Ù„Ø¯ÙˆØ±</span>${escapeHtml(card.dawr)}</span>` : ``}
        <span class="pill"><span>Ø·Ù„Ø§Ø¨</span>${fmtInt(card.students||0)}</span>
        <span class="pill"><span>ØªØºØ·ÙŠØ©</span>${fmtPct(covPct)}</span>
      </div>

      <div class="barWrap">
        <div class="bar">
          ${barSegs.map(s=>`<div class="segm" style="width:${pct(s.amount)}%; background:${s.color}"></div>`).join("")}
        </div>
      </div>
    </article>
  `;
}

  function renderBoard(){
    const grid = $("#cardGrid");
    const list = sortList(applyFilters(state.cards));
    if(!list.length){
      grid.innerHTML = `<div class="tableWrap" style="padding: 14px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ø·Ø§Ù‚Ø§Øª Ø¨Ø¹Ø¯.</div>`;
      return;
    }
    grid.innerHTML = list.map(cardHtml).join("");
  }

  // ===== List render (inline editing) =====
  function renderList(){
    const body = $("#tableBody");
    const list = sortList(applyFilters(state.cards));

    body.innerHTML = list.map(c=>{
      const goal = goalForCard(c);
      return `
        <tr data-id="${escapeHtml(c.id)}">
          <td><input class="edit" data-k="name" value="${escapeHtml(c.name)}"></td>
          <td><input class="edit" data-k="compoundCategory" value="${escapeHtml(c.compoundCategory)}"></td>
          <td><input class="edit" data-k="dawr" value="${escapeHtml(c.dawr)}"></td>
          <td><input class="edit" data-k="total" type="number" step="1" value="${escapeHtml(c.total)}"></td>
          <td><input class="edit" data-k="covered" type="number" step="1" value="${escapeHtml(c.covered)}"></td>
          <td><input class="edit" data-k="students" type="number" step="1" value="${escapeHtml(c.students)}"></td>
          <td style="white-space:nowrap;">${fmtMoney(goal)} <span class="sar">ï·¼</span></td>
          <td>
            <div class="rowBtns">
              <button class="btn small" data-act="open">ØªÙØ§ØµÙŠÙ„</button>
              <button class="btn small" data-act="del">Ø­Ø°Ù</button>
            </div>
          </td>
        </tr>
      `;
    }).join("");

    // Bind inline edits
    body.querySelectorAll("input.edit").forEach(inp=>{
      inp.addEventListener("change", ()=>{
        const tr = inp.closest("tr");
        const id = tr.getAttribute("data-id");
        const k = inp.getAttribute("data-k");
        const card = state.cards.find(x=>x.id===id);
        if(!card) return;
        let v = inp.value;
        if(["total","covered","students"].includes(k)) v = Math.max(0, Number(v||0)||0);
        card[k] = v;
        state.cards = normalizeCardsV2(state.cards);
        state.meta.updated_at = now();
        saveLocal();
        markDirty(true);
        refreshFilters();
        renderAll(); // updates board + computed columns
      });
    });

    body.querySelectorAll("button[data-act]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const tr = btn.closest("tr");
        const id = tr.getAttribute("data-id");
        if(btn.getAttribute("data-act")==="open"){
          navigateDetail(id);
        }else{
          // delete
          if(!confirm("Ø­Ø°Ù Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©ØŸ")) return;
          state.cards = state.cards.filter(x=>x.id!==id);
          state.meta.updated_at = now();
          saveLocal();
          markDirty(true);
          refreshFilters();
          renderAll();
        }
      });
    });
  }

  // ===== Detail page =====
  const detailPage = $("#detailPage");
  const detailTitle = $("#detailTitle");
  const detailKPIWrap = $("#detailKPIWrap");
  const detailPanelSummary = $("#detailPanelSummary");
  const detailPanelStages = $("#detailPanelStages");
  const detailPanelFull = $("#detailPanelFull");

  function setDetailTab(tab){
    $$("#detailTabs .detailTab").forEach(b=>b.classList.toggle("active", b.getAttribute("data-tab")===tab));
    const map = { summary: detailPanelSummary, stages: detailPanelStages, full: detailPanelFull };
    Object.entries(map).forEach(([k,el])=>el.classList.toggle("active", k===tab));
  }
  $("#detailTabs").addEventListener("click", (e)=>{
    const b = e.target.closest(".detailTab");
    if(!b) return;
    setDetailTab(b.getAttribute("data-tab"));
  });

  function renderDetail(card){
  if(!card) return;

  normalizeStages(); // ensure stage schema
  detailTitle.textContent = card.name || "Ø§Ù„ØªÙØ§ØµÙŠÙ„";

  const plan = computeStagePlan(card);
  const total = plan.total;
  const covered = plan.coveredNow;
  const covPct = total>0 ? (covered/total*100) : 0;

  const {goal, amountToCover, rate} = calcPortfolioGoal(total, covered);
  const stageSum = plan.plans.reduce((a,p)=>a + p.incrementAmount, 0);

  // KPIs (Sticky-style but inside existing wrapper)
  detailKPIWrap.innerHTML = `
    <div class="hero">
      <div class="heroTitle">${escapeHtml(card.name||"â€”")}</div>
      <div class="heroSub">Ø§Ù„ØªÙƒÙ„ÙØ©ØŒ Ø§Ù„ØªØºØ·ÙŠØ©ØŒ Ù‡Ø¯Ù Ø§Ù„Ù…Ø­ÙØ¸Ø©ØŒ Ø«Ù… Ø§Ù„Ù…Ø±Ø§Ø­Ù„.</div>
      <div class="heroKpis">
        <div class="tile">
          <div class="tK">Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©</div>
          <div class="tV">${fmtMoney(total)}<span class="sar">ï·¼</span></div>
          <div class="tS">Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨: ${fmtInt(card.students||0)}</div>
        </div>
        <div class="tile">
          <div class="tK">Ø§Ù„Ù…ØºØ·Ù‘Ù‰ Ø§Ù„Ø­Ø§Ù„ÙŠ</div>
          <div class="tV">${fmtMoney(covered)}<span class="sar">ï·¼</span></div>
          <div class="tS">Ù†Ø³Ø¨Ø© Ø§Ù„ØªØºØ·ÙŠØ©: ${fmtPct(covPct)}</div>
        </div>
        <div class="tile">
          <div class="tK">Ù‡Ø¯Ù Ø§Ù„Ù…Ø­ÙØ¸Ø©</div>
          <div class="tV">${fmtMoney(Number.isFinite(goal)?goal:0)}<span class="sar">ï·¼</span></div>
          <div class="tS">Ø§Ù„Ø¹Ø§Ø¦Ø¯ Ø§Ù„Ø³Ù†ÙˆÙŠ: ${fmtPct((rate||0)*100)}</div>
        </div>
        <div class="tile">
          <div class="tK">Ø§Ù„ØªØµÙ†ÙŠÙ</div>
          <div class="tV tVSmall">${escapeHtml(card.compoundCategory||"â€”")} <span class="muted">${escapeHtml(card.dawr||"")}</span></div>
          <div class="tS">Ø§Ø¶ØºØ· â€œØªØ­Ø¯ÙŠØ«â€ Ù„Ø¬Ù„Ø¨ Ø¢Ø®Ø± Ù†Ø³Ø®Ø©</div>
        </div>
      </div>
    </div>
  `;

  // Summary panel: big segmented bar + legend
  const pct=(amt)=> total>0 ? (amt/total*100) : 0;
  const barSegs=[
    {amount: covered, color:"rgba(247,168,163,1)", label:`Ø§Ù„Ø­Ø§Ù„ÙŠ: ${fmtMoney(covered)} ï·¼`},
    ...plan.plans.map(p=>({amount:p.incrementAmount, color:p.color, label:`${p.name}: ${fmtMoney(p.incrementAmount)} ï·¼`})),
    {amount: plan.remain, color:"#e5e7eb", label:`Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${fmtMoney(plan.remain)} ï·¼`}
  ].filter(s=>s.amount>0.0001);

  detailPanelSummary.innerHTML = `
    <div class="bigCard">
      <div class="bigTop">
        <div class="bigK">Ù…Ù„Ø®Øµ Ø§Ù„Ø®Ø·Ø©</div>
        <div class="bigNote">Ù…Ø¨Ù„Øº Ø§Ù„ØªØºØ·ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: <b>${fmtMoney(amountToCover)}</b> ï·¼</div>
      </div>
      <div class="bigBar">${barSegs.map(s=>`<div class="segm" title="${escapeHtml(s.label)}" style="width:${pct(s.amount)}%; background:${s.color}"></div>`).join("")}</div>
      <div class="legend">
        <span class="leg"><span class="dot" style="background:rgba(247,168,163,1)"></span>Ø§Ù„Ø­Ø§Ù„ÙŠ: ${fmtMoney(covered)} ï·¼</span>
        <span class="leg"><span class="dot" style="background:#111827"></span>Ø§Ù„Ù…Ø±Ø§Ø­Ù„: ${fmtMoney(stageSum)} ï·¼</span>
        <span class="leg"><span class="dot" style="background:#e5e7eb"></span>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${fmtMoney(plan.remain)} ï·¼</span>
      </div>
      <div class="afterPlan">Ø¨Ø¹Ø¯ Ø®Ø·Ø© Ø§Ù„Ù…Ø±Ø§Ø­Ù„: ØªØµÙ„ Ø§Ù„ØªØºØ·ÙŠØ© Ø¥Ù„Ù‰ <b>${fmtPct(total>0 ? (plan.afterCovered/total*100) : 0)}</b></div>
    </div>
  `;

  // Stages panel: goal prominent, per-stage color
  detailPanelStages.innerHTML = `
    <div class="stageGrid">
      ${plan.plans.filter(p=>p.incrementAmount>0.0001).map((p, idx)=>`
        <div class="stage" style="--stageColor:${escapeHtml(p.color)}">
          <div class="row">
            <b>${escapeHtml(p.name)}</b>
            <span>${escapeHtml(p.period||"")}</span>
          </div>
          <div class="lbl">Ù‡Ø¯Ù Ø§Ù„Ù…Ø±Ø­Ù„Ø©</div>
          <div class="amt">${fmtMoney(p.goal)}<span class="cur">ï·¼</span></div>
          <div class="mini">ØªØºØ·ÙŠØ©: ${fmtMoney(p.incrementAmount)} ï·¼</div>
        </div>
      `).join("")}
    </div>
  `;

  // Full panel: breakdown + raw numbers
  const admin = Number(card.admin||0)||0;
  const halaqat = Number(card.halaqat||0)||0;
  const programs = Number(card.programs||0)||0;

  detailPanelFull.innerHTML = `
    <div class="fullGrid">
      <div class="fullCard">
        <div class="fullH">ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªÙƒÙ„ÙØ©</div>
        <div class="fullRow"><span>ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</span><b>${fmtMoney(admin)} ï·¼</b></div>
        <div class="fullRow"><span>ØªÙƒÙ„ÙØ© Ø§Ù„Ø­Ù„Ù‚Ø§Øª</span><b>${fmtMoney(halaqat)} ï·¼</b></div>
        <div class="fullRow"><span>ØªÙƒÙ„ÙØ© Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬</span><b>${fmtMoney(programs)} ï·¼</b></div>
        <div class="fullRow total"><span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span><b>${fmtMoney(total)} ï·¼</b></div>
      </div>

      <div class="fullCard">
        <div class="fullH">Ø§Ù„ØªØºØ·ÙŠØ©</div>
        <div class="fullRow"><span>Ø§Ù„Ù…ØºØ·Ù‘Ù‰ Ø§Ù„Ø­Ø§Ù„ÙŠ</span><b>${fmtMoney(covered)} ï·¼</b></div>
        <div class="fullRow"><span>Ù†Ø³Ø¨Ø© Ø§Ù„ØªØºØ·ÙŠØ©</span><b>${fmtPct(covPct)}</b></div>
        <div class="fullRow"><span>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</span><b>${fmtMoney(Math.max(0,total-covered))} ï·¼</b></div>
      </div>

      <div class="fullCard">
        <div class="fullH">Ù‡Ø¯Ù Ø§Ù„Ù…Ø­ÙØ¸Ø©</div>
        <div class="fullRow"><span>Ø§Ù„Ù‡Ø¯Ù</span><b>${fmtMoney(Number.isFinite(goal)?goal:0)} ï·¼</b></div>
        <div class="fullRow"><span>Ù†Ø·Ø§Ù‚ Ø§Ù„Ù‡Ø¯Ù</span><b>${(state.settings.goal_scope==="total"?"Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ":"Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ")}</b></div>
        <div class="fullRow"><span>Ø§Ù„Ø¹Ø§Ø¦Ø¯ Ø§Ù„Ø³Ù†ÙˆÙŠ</span><b>${fmtPct((rate||0)*100)}</b></div>
      </div>
    </div>
  `;
}

  function openCard(id){ openDetail(id); }

function openDetail(id){
  // alias used by cardHtml

    selectedId = id;
    const card = state.cards.find(x=>x.id===id);
    if(!card) return;
    renderDetail(card);
    detailPage.classList.add("isOpen");
    detailPage.setAttribute("aria-hidden","false");
    // Update hash
    try{
      const url = new URL(location.href);
      url.hash = "page=detail&card=" + encodeURIComponent(id);
      history.replaceState(null,"",url.toString());
    }catch(e){}
  }
  function closeDetail(){
    detailPage.classList.remove("isOpen");
    detailPage.setAttribute("aria-hidden","true");
    try{
      const url = new URL(location.href);
      url.hash = "";
      history.replaceState(null,"",url.toString());
    }catch(e){}
  }
  $("#detailBack").addEventListener("click", closeDetail);
  $("#detailPublish").addEventListener("click", publish);

  // gestures
  (function(){
    let sx=0, sy=0, cx=0, cy=0, dragging=false, edge=false;
    detailPage.addEventListener("touchstart", (e)=>{
      if(!detailPage.classList.contains("isOpen")) return;
      const t = e.touches[0];
      sx=cx=t.clientX; sy=cy=t.clientY;
      edge = sx < 18;
      dragging = true;
    }, {passive:true});
    detailPage.addEventListener("touchmove", (e)=>{
      if(!dragging) return;
      const t = e.touches[0];
      cx=t.clientX; cy=t.clientY;
    }, {passive:true});
    detailPage.addEventListener("touchend", ()=>{
      if(!dragging) return;
      dragging=false;
      const dx=cx-sx, dy=cy-sy;
      if(edge && dx>80 && Math.abs(dy)<60){ closeDetail(); return; }
      if(dy>140 && Math.abs(dx)<90){ closeDetail(); }
    });
  })();

  function navigateDetail(id){ openDetail(id); }

  // Board click => detail
  $("#cardGrid").addEventListener("click", (e)=>{
    const el = e.target.closest(".card");
    if(!el) return;
    const id = el.getAttribute("data-id");
    navigateDetail(id);
  });

  // ===== Manage: add card, JSON backup, CSV import =====
  $("#btnAddCard").addEventListener("click", ()=>{
    if(!isUnlocked()){ toast("Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ù…Ø®ÙÙŠØ©"); return; }
    const c = { id: uid("c"), name: "Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…", total:0, covered:0, students:0, compoundCategory:"", dawr:"", admin:0, halaqat:0, programs:0 };
    state.cards.unshift(c);
    state.meta.updated_at = now();
    saveLocal();
    markDirty(true);
    refreshFilters();
    renderAll();
    toast("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©");
  });

  $("#btnExportJson").addEventListener("click", ()=>{
    const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json;charset=utf-8"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "backup.json";
    a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href), 4000);
  });
  $("#btnImportJson").addEventListener("click", ()=>{
    if(!isUnlocked()){ toast("Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ù…Ø®ÙÙŠØ©"); return; }
    $("#jsonFile").click();
  });
  $("#jsonFile").addEventListener("change", async ()=>{
    const f = $("#jsonFile").files?.[0];
    if(!f) return;
    const txt = await f.text();
    try{
      const obj = migrate(JSON.parse(txt));
      state = obj;
      state.meta.updated_at = now();
      saveLocal();
      markDirty(true);
      refreshFilters();
      renderAll();
      toast("ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯");
    }catch(e){
      toast("Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­");
    }finally{
      $("#jsonFile").value="";
    }
  });

  // CSV parse (simple robust)
  function parseCSV(text){
    const rows = [];
    let row = [], cur="", inQ=false;
    for(let i=0;i<text.length;i++){
      const ch=text[i], nxt=text[i+1];
      if(ch === '"' ){
        if(inQ && nxt === '"'){ cur+='"'; i++; }
        else inQ = !inQ;
      } else if(ch === ',' && !inQ){
        row.push(cur); cur="";
      } else if((ch === '\n' || ch === '\r') && !inQ){
        if(ch === '\r' && nxt === '\n') i++;
        row.push(cur); cur="";
        if(row.some(x=>String(x).trim()!=="")) rows.push(row);
        row=[];
      } else {
        cur+=ch;
      }
    }
    row.push(cur);
    if(row.some(x=>String(x).trim()!=="")) rows.push(row);
    return rows;
  }

  function guessMap(headers){
    const h = headers.map(x=>String(x||"").trim().toLowerCase());
    const find = (keys)=>h.findIndex(v=>keys.some(k=>v.includes(k)));
    return {
      name: find(["Ø§Ø³Ù…","name"]),
      total: find(["ØªÙƒÙ„ÙØ©","Ø§Ø¬Ù…Ø§Ù„ÙŠ","total","cost"]),
      covered: find(["Ù…ØºØ·","covered","current"]),
      students: find(["Ø·Ù„Ø§Ø¨","students"]),
      compoundCategory: find(["Ù…Ø¬Ù…Ø¹","compound"]),
      dawr: find(["Ø¯ÙˆØ±","Ø§Ù„Ø¯ÙˆØ±","hall","dawr"]),
    };
  }

  function renderImportPreview(headers, dataRows){
    const map = guessMap(headers);
    const box = $("#importPreview");
    box.style.display = "block";

    const headOpts = headers.map((x,i)=>`<option value="${i}">${escapeHtml(x||("Ø¹Ù…ÙˆØ¯ "+(i+1)))}</option>`).join("");

    const sel = (key, label, idx)=>`
      <div style="flex:1; min-width: 180px;">
        <div class="k">${escapeHtml(label)}</div>
        <select class="select" data-map="${key}" style="width:100%;">
          <option value="-1">â€”</option>
          ${headOpts}
        </select>
      </div>
    `;

    box.innerHTML = `
      <div class="tableWrap" style="padding:12px;">
        <div class="row" style="gap:10px; flex-wrap:wrap;">
          ${sel("name","Ø§Ù„Ø§Ø³Ù…", map.name)}
          ${sel("compoundCategory","Ø§Ù„Ù…Ø¬Ù…Ø¹", map.compoundCategory)}
          ${sel("dawr","Ø§Ù„Ø¯ÙˆØ±", map.dawr)}
          ${sel("total","Ø§Ù„ØªÙƒÙ„ÙØ©", map.total)}
          ${sel("covered","Ø§Ù„Ù…ØºØ·Ù‘Ù‰", map.covered)}
          ${sel("students","Ø§Ù„Ø·Ù„Ø§Ø¨", map.students)}
        </div>

        <div class="rowBtns" style="margin-top:10px;">
          <button class="btn primary adminOnly" id="btnApplyImport">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯</button>
          <button class="btn" id="btnCancelImport">Ø¥Ù„ØºØ§Ø¡</button>
        </div>

        <div class="k" style="margin-top:10px;">Ù…Ø¹Ø§ÙŠÙ†Ø© Ø£ÙˆÙ„ 5 ØµÙÙˆÙ:</div>
        <div style="overflow:auto; border-radius:16px; border:1px solid rgba(11,18,32,.08); background: rgba(255,255,255,.74);">
          <table style="min-width: 720px">
            <thead><tr>${headers.map(x=>`<th>${escapeHtml(x||"")}</th>`).join("")}</tr></thead>
            <tbody>
              ${dataRows.slice(0,5).map(r=>`<tr>${headers.map((_,i)=>`<td>${escapeHtml(r[i]||"")}</td>`).join("")}</tr>`).join("")}
            </tbody>
          </table>
        </div>
      </div>
    `;

    // Set defaults
    $$('#importPreview select[data-map]').forEach(s=>{
      const key = s.getAttribute("data-map");
      const idx = map[key];
      if(idx>=0) s.value = String(idx);
      else s.value = "-1";
    });

    $("#btnCancelImport").addEventListener("click", ()=>{ box.style.display="none"; box.innerHTML=""; });

    $("#btnApplyImport").addEventListener("click", ()=>{
      if(!isUnlocked()){ toast("Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ù…Ø®ÙÙŠØ©"); return; }
      const chosen = {};
      $$('#importPreview select[data-map]').forEach(s=>{
        chosen[s.getAttribute("data-map")] = Number(s.value);
      });

      const newCards = [];
      for(const r of dataRows){
        const name = chosen.name>=0 ? String(r[chosen.name]||"").trim() : "";
        if(!name) continue;
        const c = {
          id: uid("c"),
          name,
          compoundCategory: chosen.compoundCategory>=0 ? String(r[chosen.compoundCategory]||"").trim() : "",
          dawr: chosen.dawr>=0 ? String(r[chosen.dawr]||"").trim() : "",
          total: chosen.total>=0 ? Math.max(0, Number(String(r[chosen.total]||"").replace(/[^\d.]/g,""))||0) : 0,
          covered: chosen.covered>=0 ? Math.max(0, Number(String(r[chosen.covered]||"").replace(/[^\d.]/g,""))||0) : 0,
          students: chosen.students>=0 ? Math.max(0, Number(String(r[chosen.students]||"").replace(/[^\d.]/g,""))||0) : 0,
          admin:0, halaqat:0, programs:0
        };
        newCards.push(c);
      }

      // Merge strategy: by name+compoundCategory (if found, update; else add)
      for(const c of newCards){
        const existing = state.cards.find(x=>x.name===c.name && (x.compoundCategory||"")===(c.compoundCategory||""));
        if(existing){
          existing.total = c.total;
          existing.covered = c.covered;
          existing.students = c.students;
          existing.dawr = c.dawr || existing.dawr;
        }else{
          state.cards.push(c);
        }
      }

      state.cards = normalizeCardsV2(state.cards);
      state.meta.updated_at = now();
      saveLocal();
      markDirty(true);
      refreshFilters();
      renderAll();
      box.style.display="none"; box.innerHTML="";
      toast("ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯");
    });
  }

  async function handleCsvText(text){
    const rows = parseCSV(text);
    if(rows.length < 2){ toast("CSV ØºÙŠØ± ÙƒØ§ÙÙ"); return; }
    const headers = rows[0];
    const dataRows = rows.slice(1);
    renderImportPreview(headers, dataRows);
  }

  $("#csvFile").addEventListener("change", async ()=>{
    if(!isUnlocked()){ toast("Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ù…Ø®ÙÙŠØ©"); $("#csvFile").value=""; return; }
    const f = $("#csvFile").files?.[0];
    if(!f) return;
    const txt = await f.text();
    await handleCsvText(txt);
    $("#csvFile").value="";
  });

  $("#btnCsvPaste").addEventListener("click", async ()=>{
    if(!isUnlocked()){ toast("Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ù…Ø®ÙÙŠØ©"); return; }
    const txt = prompt("Ø§Ù„ØµÙ‚ CSV Ù‡Ù†Ø§:");
    if(!txt) return;
    await handleCsvText(txt);
  });

  // ===== Stage editor (admin) =====
  function renderStageEditor(){
  const el = $("#stageEditor");
  if(!el) return;
  if(!isUnlocked()){ el.innerHTML = ""; return; }

  normalizeStages();
  el.innerHTML = `
    <div style="display:flex; flex-direction:column; gap:10px;">
      ${(state.stages||[]).map((st,i)=>`
        <div class="stageRow" data-id="${escapeHtml(st.id)}" style="box-shadow:none;">
          <div class="stageRowTop">
            <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
              <span style="display:inline-block;width:12px;height:12px;border-radius:999px;background:${escapeHtml(st.color)};"></span>
              <input class="edit" data-k="name" value="${escapeHtml(st.name)}" style="max-width:210px;">
              <input class="edit" data-k="period" value="${escapeHtml(st.period||"")}" placeholder="Ù…Ø«Ø§Ù„: Ø®Ù„Ø§Ù„ Ø±Ù…Ø¶Ø§Ù†" style="max-width:190px;">
            </div>
            <div style="display:flex; align-items:end; gap:10px; flex-wrap:wrap;">
              <div>
                <div class="k">Ù†Ø³Ø¨Ø© Ø§Ù„ØªØºØ·ÙŠØ© Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ø±Ø­Ù„Ø©</div>
                <input class="edit" data-k="target_pct" type="number" step="1" value="${escapeHtml(st.target_pct)}" style="width:120px;">
              </div>
              <div>
                <div class="k">Ù„ÙˆÙ†</div>
                <input class="edit" data-k="color" type="color" value="${escapeHtml(st.color)}" style="width:58px; height:40px; padding:0; border-radius:12px;">
              </div>
              <button class="btn small" data-act="del">Ø­Ø°Ù</button>
            </div>
          </div>
        </div>
      `).join("")}
    </div>
  `;

  el.querySelectorAll("input.edit").forEach(inp=>{
    inp.addEventListener("change", ()=>{
      const row = inp.closest("[data-id]");
      const id = row.getAttribute("data-id");
      const st = state.stages.find(x=>x.id===id);
      if(!st) return;
      const k = inp.getAttribute("data-k");
      let v = inp.value;
      if(k==="target_pct") v = clamp(Number(v||0)||0, 0, 100);
      st[k] = v;
      state.stages = normalizeStagesV2(state.stages);
      state.meta.updated_at = now();
      saveLocal();
      markDirty(true);
      renderAll();
    });
  });

  el.querySelectorAll("button[data-act='del']").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const row = btn.closest("[data-id]");
      const id = row.getAttribute("data-id");
      state.stages = (state.stages||[]).filter(x=>x.id!==id);
      state.stages = normalizeStagesV2(state.stages);
      state.meta.updated_at = now();
      saveLocal();
      markDirty(true);
      renderAll();
    });
  });
}
  $("#btnAddStage").addEventListener("click", ()=>{
    if(!isUnlocked()){ toast("Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ù…Ø®ÙÙŠØ©"); return; }
    state.stages.push({ id: uid("st"), name: "Ù…Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©", target_ratio: 0.1, target:null, color: "#6366F1" });
    state.stages = normalizeStagesV2(state.stages);
    state.meta.updated_at = now();
    saveLocal();
    markDirty(true);
    renderAll();
  });

  // ===== Settings (admin) =====
  $("#btnSaveSettings").addEventListener("click", ()=>{
    if(!isUnlocked()){ toast("Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ù…Ø®ÙÙŠØ©"); return; }

    // Legacy ratio controls (kept)
    const r = Number($("#setGoalRatio").value || 1);
    let c = $("#setCoverageRatio").value;
    c = (c==="" || c==null) ? null : Number(c);
    state.settings.goal_ratio = (isFinite(r) && r>0) ? r : 1;
    state.settings.coverage_ratio = (c==null || !isFinite(c)) ? null : clamp(c,0,1.5);

    // Portfolio settings (recommended)
    const rr = Number($("#setReturnRate")?.value ?? (state.settings.return_rate ?? 9));
    const scope = $("#setGoalScope")?.value || (state.settings.goal_scope ?? "remaining");
    state.settings.return_rate = (isFinite(rr) && rr>0) ? rr : 9;
    state.settings.goal_scope = (scope==="total") ? "total" : "remaining";

    state.meta.updated_at = now();
    saveLocal();
    markDirty(true);
    renderAll();
    toast("ØªÙ… Ø§Ù„Ø­ÙØ¸");
  });
  $("#btnLock").addEventListener("click", lockNow);

  // ===== Detail open by hash route =====
  function handleRoute(){
    const h = (location.hash||"").replace(/^#/,"");
    const mPage = h.match(/(?:^|&)page=([^&]+)/);
    const page = mPage ? decodeURIComponent(mPage[1]) : "";
    const mCard = h.match(/(?:^|&)card=([^&]+)/);
    const id = mCard ? decodeURIComponent(mCard[1]) : null;

    if(page==="detail" && id && state.cards.some(c=>c.id===id)){
      openDetail(id);
    }else{
      // keep closed
    }
  }
  window.addEventListener("hashchange", ()=>{ try{ handleRoute(); }catch(e){} });

  // ===== Render =====
  function renderAll(){
    refreshFilters();
    renderBoard();
    renderList();
    renderStageEditor();

    // settings fields
    if($("#setGoalRatio")) $("#setGoalRatio").value = String(state.settings.goal_ratio ?? 1);
    if($("#setCoverageRatio")) $("#setCoverageRatio").value = (state.settings.coverage_ratio==null ? "" : String(state.settings.coverage_ratio));
    if($("#setReturnRate")) $("#setReturnRate").value = String(state.settings.return_rate ?? 9);
    if($("#setGoalScope")) $("#setGoalScope").value = String(state.settings.goal_scope ?? "remaining");

    // update last sync display from state meta
    setLastSync(state.meta.updated_at || 0);
  }

  // ===== Init =====
  (async function init(){
    // load local first for speed
    const local = loadLocal();
    if(local){
      state = local;
      // consider local dirty if base_rev differs
      markDirty(!!local.__dirty || false);
    }

    applyLockState();
    startPresence();

    // Pull latest ONCE on first load (so new visitor sees latest) but keep manual thereafter
    try{
      const remote = await fetchRemote();
      // If local is empty or not dirty, accept remote
      const localHasData = (state.cards||[]).length > 0 || (state.meta.updated_at||0) > 0;
      if(!localHasData){
        state = remote;
        state.meta.base_rev = remote.meta.rev;
        markDirty(false);
      }else{
        // keep local as working copy; only auto-accept if local not dirty and remote is newer
        const localTs = Number(state.meta.updated_at||0)||0;
        const remoteTs = Number(remote.meta.updated_at||0)||0;
        if(!dirty && remoteTs > localTs){
          state = remote;
          state.meta.base_rev = remote.meta.rev;
          markDirty(false);
        }else{
          // just keep remoteSnapshot for conflict detection
          state.meta.base_rev = state.meta.base_rev || remote.meta.rev || state.meta.rev;
        }
      }
      saveLocal();
    }catch(e){
      // offline ok
    }

    renderAll();
    handleRoute();
  })();

})();
</script>
</body>
</html>
